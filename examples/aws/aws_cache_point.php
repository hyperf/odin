<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */
! defined('BASE_PATH') && define('BASE_PATH', dirname(__DIR__, 2));

require_once dirname(__FILE__, 3) . '/vendor/autoload.php';

use Hyperf\Context\ApplicationContext;
use Hyperf\Di\ClassLoader;
use Hyperf\Di\Container;
use Hyperf\Di\Definition\DefinitionSourceFactory;
use Hyperf\Odin\Api\RequestOptions\ApiOptions;
use Hyperf\Odin\Logger;
use Hyperf\Odin\Message\AssistantMessage;
use Hyperf\Odin\Message\CachePoint;
use Hyperf\Odin\Message\SystemMessage;
use Hyperf\Odin\Message\UserMessage;
use Hyperf\Odin\Model\AwsBedrockModel;

use function Hyperf\Support\env;

ClassLoader::init();

$container = ApplicationContext::setContainer(new Container((new DefinitionSourceFactory())()));

// 创建 AWS Bedrock 模型实例
// 使用 Claude 3 Sonnet 模型 ID
$model = new AwsBedrockModel(
    'us.anthropic.claude-3-7-sonnet-20250219-v1:0',
    [
        'access_key' => env('AWS_ACCESS_KEY'),
        'secret_key' => env('AWS_SECRET_KEY'),
        'region' => env('AWS_REGION', 'us-east-1'),
    ],
    new Logger(),
);
$model->setApiRequestOptions(new ApiOptions([
    // 如果你的环境不需要代码，那就不用
    'proxy' => env('HTTP_CLIENT_PROXY'),
]));

$messages = [
    new SystemMessage('你是一位友好、专业的AI助手，擅长简明扼要地回答问题'),
    new UserMessage('请详细介绍一下狼人杀的玩法'),
    new AssistantMessage(
        <<<'MARKDOWN'
 狼人杀是一款经典的社交推理类桌游，玩家通过角色扮演、发言辩论和逻辑推理来争夺阵营胜利。以下是详细玩法介绍：

 ---

 ### **一、基础设定**
 1. **游戏人数**：通常8-18人参与，分属两大阵营：
   - **狼人阵营**：1-4名狼人，夜晚可击杀玩家。
   - **好人阵营**：
     - **神民**（拥有特殊技能的角色，如预言家、女巫等）
     - **平民**（无技能，靠推理投票）。

 2. **胜利条件**：
   - **狼人阵营**：淘汰所有神民或平民。
   - **好人阵营**：淘汰所有狼人。
   - *特殊角色可能改变胜利条件（如丘比特绑定的“情侣”形成第三方阵营）*。

 ---

 ### **二、游戏流程**
 游戏分为**夜晚**和**白天**交替进行，由主持人（上帝）引导流程。

 #### **1. 夜晚阶段**
 所有玩家闭眼，按顺序唤醒角色行动：
 - **狼人**：睁眼选择击杀一名玩家。
 - **预言家**：查验一名玩家身份（好人/狼人）。
 - **女巫**：可选择使用解药（救人）或毒药（毒杀一人），同一晚只能用一种。
 - **守卫**：选择保护一名玩家，使其免疫当夜伤害（不能连续两晚保护同一人）。
 - **其他角色**（如猎人、丘比特等）：根据角色技能行动。

 #### **2. 白天阶段**
 1. **公布死亡信息**：主持人告知昨夜被击杀的玩家（可能被女巫救活则无人死亡）。
 2. **轮流发言**：玩家依次发言，分析线索、表明身份或指控他人。
 3. **投票放逐**：所有玩家投票选出怀疑的狼人，得票最多者出局（需公开身份）。
 4. **特殊技能触发**：如猎人被放逐可开枪带走一人。

 ---

 ### **三、核心角色与技能**
 #### **好人阵营**
 1. **预言家**：每晚查验一人身份，带领好人找出狼人。
 2. **女巫**：拥有解药和毒药，可救人/杀人，需谨慎使用。
 3. **守卫**：通过保护关键角色（如预言家）干扰狼人战术。
 4. **猎人**：被放逐或击杀时可带走一名玩家。
 5. **平民**：无技能，通过发言和投票帮助好人胜利。

 #### **狼人阵营**
 1. **普通狼人**：夜间杀人，白天伪装成好人。
 2. **白狼王**：可在白天自爆并带走一名玩家。
 3.隐 **狼**：不被预言家查验为狼人，但夜间无法杀人。

 #### **特殊角色（可选）**
 - **丘比特**：开局指定两人成为“情侣”，若一方死亡，另一方殉情。
 - **盗贼**：在角色池中替换身份。
 - **混血儿**：选择支持一名玩家，目标阵营胜利则混血儿胜利。

 ---

 ### **四、常见术语**
 - **金水**：预言家查验的好人。
 - **银水**：女巫救活的人（可能是好人或自刀狼）。
 - **悍跳**：狼人冒充预言家混淆视听。
 - **警徽流**：预言家通过警长投票传递查验信息。
 - **倒钩**：狼人假装帮好人投票，获取信任。
 - **绑票**：狼人集体投票淘汰好人。

 ---

 ### **五、策略技巧**
 #### **好人阵营**
 1. 预言家应尽快跳身份并报查验，争取警徽。
 2. 女巫首夜可救疑似预言家，后期毒药针对可疑玩家。
 3. 平民避免划水，通过分析发言找出矛盾点。

 #### **狼人阵营**
 1. 狼队夜间统一刀法，优先击杀神民。
 2. 悍跳预言家或穿其他神职衣服，扰乱好人视角。
 3. 制造逻辑漏洞，引导好人互投。

 ---

 ### **六、变体规则**
 1. **新月事件**：加入随机事件卡（如强制禁言、改变投票规则）。
 2. **板子调整**：如“预女猎白”（预言家、女巫、猎人、白痴）或“狼王守卫”。
 3. **角色扩展**：加入“骑士”（可决斗验人）、“摄梦人”等新角色。

 ---

 ### **七、注意事项**
 1. 遵守发言顺序，禁止场外信息（如表情、手势）。
 2. 出局玩家需离场或保持沉默，避免干扰游戏。
 3. 尊重游戏规则，避免贴脸（如发誓、情绪绑架）。

 通过角色扮演、逻辑推理和语言博弈，狼人杀不仅能锻炼玩家的观察力和口才，还能考验团队合作与心理素质。不同角色组合和玩家风格会让每局游戏充满变化和惊喜！s
 MARKDOWN
    ),
    new UserMessage('再介绍狼人杀的法官'),
    new AssistantMessage(
        <<<'MARKDOWN'
 # 狼人杀法官详细介绍

 法官（又称"上帝"）是狼人杀游戏中至关重要的角色，负责整个游戏流程的组织和裁决。以下是关于狼人杀法官的详细介绍：

 ## 一、法官的基本职责

 1. **游戏准备**
   - 根据人数分配角色卡牌
   - 解释游戏规则和胜利条件
   - 组织玩家就座并编号

 2. **游戏流程控制**
   - 宣布夜晚/白天的开始与结束
   - 按顺序唤醒各角色执行夜间行动
   - 控制白天发言顺序和时长
   - 组织投票环节并统计结果

 3. **信息传递**
   - 告知预言家查验结果
   - 向女巫展示被狼人杀害的玩家
   - 公布夜晚死亡情况和投票放逐结果
   - 宣布特殊事件（如猎人开枪、遗言等）

 4. **裁决争议**
   - 处理规则争议和异常情况
   - 判定特殊技能触发条件
   - 防止场外信息和作弊行为

 ## 二、法官的技巧与素质

 1. **专业素养**
   - 熟悉全部角色技能和交互规则
   - 公正客观，不偏袒任何阵营
   - 记忆力强，能记住所有角色分配
   - 语言表达清晰，指令准确

 2. **节奏控制**
   - 掌握适当的游戏节奏，避免拖沓或过快
   - 合理分配发言时间，保证每位玩家参与度
   - 关键时刻（如平票）及时给出处理方案

 3. **氛围营造**
   - 创造轻松但紧张的游戏氛围
   - 适当使用语言渲染增加游戏代入感
   - 鼓励新手参与，提供必要提示

 4. **场控能力**
   - 有效制止场外交流和暗号
   - 处理情绪激动的玩家
   - 维持游戏秩序，确保规则执行

 ## 三、法官台词与流程示例

 1. **开场白**
   "各位玩家请闭上眼睛，低头将手放在膝盖上。现在我将为大家分发身份牌，拿到后请悄悄查看并记住自己的身份..."

 2. **夜晚流程**
   - "天黑请闭眼，所有玩家低头闭眼"
   - "狼人请睁眼，选择今晚要杀的人"（等待狼人指认）
   - "狼人请闭眼"
   - "预言家请睁眼，你想查验谁的身份"（等待预言家指认，然后做出好人/狼人手势）
   - "预言家请闭眼"
   - 依次唤醒其他角色...

 3. **白天流程**
   - "天亮了，所有人请睁眼"
   - "昨晚平安夜/X号玩家被杀"
   - "从X号开始，每人有30秒发言时间"
   - "现在进入投票环节，请所有存活玩家举手投票..."

 ## 四、常见法官技巧

 1. **身份分配技巧**
   - 根据玩家水平调整神民比例
   - 避免将关系亲密的玩家分为同一阵营
   - 初学者建议使用基础配置（如"预女猎白"）

 2. **夜间操作技巧**
   - 使用遮挡物掩盖狼人指认动作
   - 即使某角色已死，仍按顺序唤醒（防止信息泄露）
   - 女巫解药使用后，不再展示死亡信息

 3. **白天控场技巧**
   - 打断过长或无效发言
   - 警惕并制止场外信息传递
   - 平票情况下采用"解除平票"或"同归于尽"规则

 4. **特殊情况处理**
   - 狼人自刀（允许或禁止）
   - 守卫自守（允许或禁止）
   - 猎人开枪时机（立即或下一轮）
   - 情侣互投处理方式

 ## 五、法官常见误区与避免方法

 1. **信息泄露**
   - 避免表情或语气暗示角色身份
   - 不要对特定玩家有额外反应
   - 保持中立表情和语调

 2. **节奏问题**
   - 避免过长等待狼人决策
   - 不要过快结束发言环节
   - 给新手适当提示但不要过度干预

 3. **规则执行**
   - 开局明确特殊规则（如自刀、毒解同时等）
   - 一旦确定规则不随意更改
   - 对违规行为坚决制止并给予适当惩罚

 ---

 优秀的法官能让狼人杀游戏体验大幅提升，通过公正裁决、流畅引导和氛围营造，使玩家充分享受推理与对抗的乐趣。作为法官，既是规则执行者，也是游戏体验的设计师，需要不断积累经验和提升技巧。

 MARKDOWN
    ),
    new UserMessage('狼人杀法官的职责和注意事项'),
];

// 添加缓存点
foreach ($messages as $message) {
    if ($message instanceof UserMessage) {
        $message->setCachePoint(new CachePoint('ephemeral'));
    }
}

$start = microtime(true);

// 使用非流式API调用
$response = $model->chat($messages);

// 输出完整响应
$message = $response->getFirstChoice()->getMessage();
if ($message instanceof AssistantMessage) {
    echo $message->getContent();
}

echo PHP_EOL;
echo '耗时' . (microtime(true) - $start) . '秒' . PHP_EOL;
echo 'token 消耗:' . $response->getUsage()?->getTotalTokens() . PHP_EOL;
var_dump($response->getUsage());
